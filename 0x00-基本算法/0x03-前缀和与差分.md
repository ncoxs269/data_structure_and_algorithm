# 1. 前缀和

对于一个给定的数列 A，它的前缀和数列 S 是通过递推能求出基本的信息之一:
$$
S[i] = \sum_{j=1}^{i}A[j]
$$
一个部分和，即数列 A 某个下标区间内的数的和，可表示为前和缀相减的形式:
$$
\mathrm{sum}(l,r) = \sum_{i=l}^{r}A[i] = S[r]-S[l-1]
$$
注意，前缀和数列 $S$ 长度一般比 $A$ 大 1，这样可以方便地处理 $A(0,r)$ 的前缀和。

在二维数组(矩阵)中，可类似地求出二维前缀和，进一步计算出二维部分和。

## 1.1 习题13：激光炸弹

一种新型的激光炸弹，可以摧毁一个边长为 R 的正方形内的所有的目标。现在地图上有 $N(N \le 10^4)$ 个目标，用整数 $X_i,Y_i$(其值在闭区间[0,5000]之内)表示目标在地图上的位置，每个目标都有一个价值 $W_i$。

激光炸弹的投放是通过卫星定位的,但其有一个缺点，就是其爆破范围，即那个边长为 R 的正方形的边必须和   x,y 轴平行。若目标位于爆破正方形的边上，该目标不会被摧毁。求一颗炸弹最多能炸掉地图上总价值为多少的目标。

## 1.2 拓展练习

[LeetCode 437. 路径总和 III](https://leetcode-cn.com/problems/path-sum-iii/)

[LeetCode 523. 连续的子数组和](https://leetcode-cn.com/problems/continuous-subarray-sum/)

[LeetCode 525. 连续数组](https://leetcode-cn.com/problems/contiguous-array/)

# 2. 差分

对于一个给定的数列 $A$，它的差分数列 $B$ 定义为:
$$
B[1] = A[1], B[i] = A[i] - A[i-1]\ (2 \le i \le n)
$$
容易发现，“前和缀”与“差分”是一对互逆运算，差分序列 $B$ 的前缀和序列就是原序列 $A$，前缀和序列 $S$ 的差分序列也是原序列 $A$。

把序列 $A$ 的区间 $[l,r]$ 加 $d$(即把 $A_l,A_{l+1},\cdots,A_r$ 都上加 $d$)，其差分序列 $B$ 的变化为 $B_l$ 加 $d$，$B_{r+1}$ 减$d$，其他位置不变。这有助于我们在很多题目中，把原序列上的“区间操作”转化为差分序列上的“单点操作”进行计算，降低求解难度。

在0x63节，我们还会继续探讨差分技巧在树上的应用。

# 题解

## 习题13：激光炸弹

因为 $X_i,Y_i$ 的值在0~5000之间,所以我们可以建立一个二维数组 $A$，其中 $A[i][j]$ 就等于位置 $(i,j)$ 上的所有目标的价值之和。即于对每个目标，令 $A[X_i,Y_i] += W_i$。

接下来我们求出 $A$ 的二维前缀和 $S$，即:
$$
S[i,j] = \sum_{x=1}^{i}\sum_{y=1}^{j}A[x][y]
$$
如下图所示，我们再观察 $S[i,j],S[i-1,j],S[i,j-1],S[i-1,j-1]$ 的关系：

![image-20220504152307185](0x03-前缀和与差分.assets/image-20220504152307185.png)

容易得到如下的递推式：
$$
S[i,j] = S[i-1,j] + S[i,j-1] - S[i-1,j-1] + A[i][j]
$$
同理，对于任意一个边长为 R 的正方形，我们有:
$$
\sum_{x=i-R+1}^{i}\sum_{y=j-R+1}^{j}A[x,y] = S[i,j]-S[i-R,j]-S[i][j-R]+S[i-R,j-R]
$$
因此,我们只需要 $O(N^2)$ 递推求出二维前缀和 $S$，然后 $O(N^2)$ 枚举边长为 $R$ 的正方形的右下角坐标 $(i,j)$，即可通过上式 $O(1)$ 计算出该正方形内所有目标价值之和，更新答案。注意，这两步其实可以同步。上面给出的两个式子蕴含的思想其实就是**“容斥原理”**，0x37节会详细探讨容斥原理的应用。

值得一提的是，上面我们把 $(X_i,Y_i)$ 作为一个“格子”，而原题中 $(X_i,Y_i)$ 是一个点，并且正方形边上的目标不会被摧毁。实际上，我们不认妨为这个点就处于“格子” $(X_i,Y_i)$ 的中心位置，格子的左上角坐标为 $(X_i-0.5,Y_i-0.5)$ ，右下角标坐为 $(X_i+0.5,Y_i+0.5)$，而正方形的右下角处于“格线交点”上，即一个值为“口.5”的坐标。这个转化与原问题是等价的。另外，本题内存限制较为严格，我们可以省略 $A$ 数组，读入直接时向 $S$ 中累加。